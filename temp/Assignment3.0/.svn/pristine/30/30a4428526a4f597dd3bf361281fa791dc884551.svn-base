import xmltodict
import json
from collections import defaultdict
from log_entry import log_entry


class xml_obj(object):

    def __init__(self, xml_list_file, xml_log_file):
        self._dir = defaultdict(set)
        self._projects = {}
        self._log = {}
        self._file_log = {}
        self._file_log_1 = defaultdict(set) #key: url value: set of commits
        self._file_detail = {}

        with open(xml_list_file) as fd:
            doc = xmltodict.parse(fd.read())

        with open(xml_log_file) as fd:
            log = xmltodict.parse(fd.read())

        for logentry in log["log"]["logentry"]:
            dict = {}

            dict["revision"] = logentry["@revision"]
            dict["author"] = logentry["author"]
            dict["date"] = logentry["date"]
            dict["msg"] = logentry["msg"]
            entry = log_entry(dict, logentry["paths"], self._file_log, self._file_log_1)
            self._log[int(logentry["@revision"])] = entry

        for entry in doc['lists']['list']['entry']:
            if entry["@kind"] == "dir":
                self._dir[entry['name']].add(None)
                full_dir = entry["name"].split('/')
                if len(full_dir) == 1:
                    self._projects[entry["name"]] = self.get_recent_file_log(entry['name'])

                if len(full_dir) > 1:
                    sep = "/"
                    path = sep.join(full_dir[:-1])
                    self._dir[path].add((entry["name"], "dir"))

            if entry["@kind"] == "file":
                full_dir = entry["name"].split('/')
                sep = "/"
                path = sep.join(full_dir[:-1])
                self._dir[path].add((full_dir[len(full_dir)-1], "file", entry["size"]))

        self.update_to_latest_rev()
        self.get_all_rev()
        print(self._file_detail)

    def get_all_rev(self):
        result = dict()
        for key in self._log:
            log_entry = self._log[key]
            result[key] = {"author": log_entry._author, "date": log_entry._date, "message": log_entry._message}
        return result

    # TODO: make it recursive
    def update_to_latest_rev(self):
        for key in self._projects:
            rev = []
            dirs = self.get_dirs(key)
            files = self.get_files(key)
            for path in files:
                rev.append(files[path]["revision"])

            for path in dirs:
                rev.append(dirs[path]["revision"])

            latest_rev = int(max(rev))
            info_rev = self.get_log_by_rev(latest_rev)
            self._projects[key]["revision"] = latest_rev
            self._projects[key]["date"] = info_rev["date"]
            self._projects[key]["message"] = info_rev["message"]

    def get_projects(self):
        return self._projects

    def get_files(self, key):
        result = {}
        for file in self._dir[key]:
            if file is not None and file[1] == "file":
                url = "{}/{}".format(key, file[0])
                get_log = self.get_recent_file_log(url)
                size = self._dir[key]
                name = file[0]
                author = get_log["author"]
                revision = get_log["revision"]
                date = get_log["date"]
                message = get_log["message"]
                size = file[2]
                type = self.get_type(file[0])
                result[file[0]] = {"name": name, "author": author, "revision": revision, "date": date, "message": message, "size": size, "type": type}
        return result

    def get_dirs(self, key):
        result = {}
        for dir in self._dir[key]:
            if dir is not None and dir[1] == "dir":
                url = "{}".format(key)
                get_log = self.get_recent_file_log(url)
                name = dir[0].split("/")
                name = name[len(name)-1]
                author = get_log["author"]
                revision = get_log["revision"]
                date = get_log["date"]
                message = get_log["message"]
                result[dir[0]] = {"name": name, "author": author, "revision": revision, "date": date, "message": message}
        return result

    def get_recent_file_log(self, path):
        rev = max(self._file_log_1[path], key=lambda x: self._file_log_1[x])
        result = dict()
        result["author"] = self._log[rev]._author
        result["revision"] = self._log[rev]._revision
        result["date"] = self._log[rev]._date
        result["message"] = self._log[rev]._message
        return result

    def get_log_by_rev(self, rev):
        result = dict()
        result["author"] = self._log[rev]._author
        result["revision"] = self._log[rev]._revision
        result["date"] = self._log[rev]._date
        result["message"] = self._log[rev]._message
        result["paths"] = self._log[rev]._paths
        return result

    def get_rev_history(self, url):
        return self._file_log_1[url]

    def get_type(self, file):
        doc = ["pdf", "pptx"]
        diff_file = ["txt"]
        code = ["py", "xml"]
        img = ["png"]
        file_ext = file.split(".")
        length = len(file_ext)
        file_ext = file_ext[length - 1]
        if file_ext in doc:
            return "Documentation"
        elif file_ext in diff_file:
            return "Testing"
        elif file_ext in code:
            return "Code"
        elif file_ext in img:
            return "Image"


